b' <!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1">  <meta name="description" content="www.paste.org - allows users to paste snippets of text, usually samples of source code, for public viewing."> <meta name="author" content="An Australian"> <link rel="icon" href="/favicon.ico"> <title>Paste code - paste.org</title>  <link href="/assets/themes/bleh/css/github-highlight.css" rel="stylesheet"> <script src="/assets/themes/bleh/js/highlight.pack.js"></script> <script>hljs.initHighlightingOnLoad();</script> </head> <body> <p><pre><code class="postgresql">CREATE OR REPLACE FUNCTION hr.fn_get_candidate_list(\n    status integer DEFAULT 0, -- \xd1\x81\xd1\x82\xd0\xb0\xd1\x82\xd1\x83\xd1\x81\n    trash boolean DEFAULT false, -- trash\n    date character varying DEFAULT \'\', -- \xd0\xb4\xd0\xb0\xd1\x82\xd0\xb0, \xd0\xba\xd0\xbe\xd0\xb3\xd0\xb4\xd0\xb0 \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb0 \xd0\xb8\xd0\xb4\xd0\xb5\xd1\x82 \xd0\xb7\xd0\xb0 \xd0\xb4\xd0\xb5\xd0\xbd\xd1\x8c \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xb7\xd0\xb0 \xd0\xbc\xd0\xb5\xd1\x81\xd1\x8f\xd1\x86\n    date_format character varying DEFAULT \'\', -- \xd1\x84\xd0\xbe\xd1\x80\xd0\xbc\xd0\xb0\xd1\x82 \xd0\xb4\xd0\xb0\xd1\x82\xd1\x8b\n    id integer DEFAULT 0, -- \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb0 \xd0\xbf\xd0\xbe id\n    name character varying DEFAULT \'\', -- \xd1\x84\xd0\xb0\xd0\xbc\xd0\xb8\xd0\xbb\xd0\xb8\xd1\x8f \xd0\xba\xd0\xb0\xd0\xbd\xd0\xb4\xd0\xb8\xd0\xb4\xd0\xb0\xd1\x82\xd0\xb0\n    firstname character varying DEFAULT \'\', -- \xd0\xb8\xd0\xbc\xd1\x8f \xd0\xba\xd0\xb0\xd0\xbd\xd0\xb4\xd0\xb8\xd0\xb4\xd0\xb0\xd1\x82\xd0\xb0\n    patronymic character varying DEFAULT \'\', -- \xd0\xbe\xd1\x82\xd1\x87\xd0\xb5\xd1\x81\xd1\x82\xd0\xb2\xd0\xbe \xd0\xba\xd0\xb0\xd0\xbd\xd0\xb4\xd0\xb8\xd0\xb4\xd0\xb0\xd1\x82\xd0\xb0\n    source integer DEFAULT 0, -- \xd0\xb8\xd1\x81\xd1\x82\xd0\xbe\xd1\x87\xd0\xbd\xd0\xb8\xd0\xba\n    date_from timestamp without time zone DEFAULT NULL, -- \xd1\x81\n    date_to timestamp without time zone DEFAULT NULL, -- \xd0\xbf\xd0\xbe \xd0\xba\xd0\xb0\xd0\xba\xd0\xbe\xd0\xb9 \xd0\xb4\xd0\xb0\xd1\x82\xd0\xb5\n    hunter integer DEFAULT 0, -- id \xd1\x85\xd0\xb0\xd0\xbd\xd1\x82\xd0\xb5\xd1\x80\xd0\xb0\n    vacancy_id integer DEFAULT 0, -- id \xd0\xb2\xd0\xb0\xd0\xba\xd0\xb0\xd0\xbd\xd1\x81\xd0\xb8\xd0\xb8\n    post_id integer DEFAULT 0, -- id \xd0\xb4\xd0\xbe\xd0\xbb\xd0\xb6\xd0\xbd\xd0\xbe\xd1\x81\xd1\x82\xd0\xb8\n    hunter_score character varying DEFAULT \'\', -- \xd0\xbe\xd1\x86\xd0\xb5\xd0\xbd\xd0\xba\xd0\xb0\n    photo_present integer DEFAULT -1, -- \xd0\xb5\xd1\x81\xd1\x82\xd1\x8c \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5\xd1\x82 \xd1\x84\xd0\xbe\xd1\x82\xd0\xbe\n    is_responce integer DEFAULT -1, -- \xd0\xbe\xd1\x82\xd0\xba\xd0\xbb\xd0\xb8\xd0\xba \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5\xd1\x82\n    is_paid boolean DEFAULT NULL, -- \xd0\xbf\xd1\x80\xd0\xbe\xd0\xbf\xd0\xbb\xd0\xb0\xd1\x87\xd0\xb5\xd0\xbd\xd0\xbe \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5\xd1\x82\n    is_test_complete boolean DEFAULT NULL, -- \xd0\xbf\xd1\x80\xd0\xbe\xd0\xb9\xd0\xb4\xd0\xb5\xd0\xbd \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5\xd1\x82 \xd1\x82\xd0\xb5\xd1\x81\xd1\x82\n    count_on_accepted boolean DEFAULT false, -- \xd0\xbf\xd0\xbe\xd0\xb4\xd1\x81\xd1\x87\xd0\xb8\xd1\x82\xd1\x8b\xd0\xb2\xd0\xb0\xd1\x82\xd1\x8c \xd0\xbb\xd0\xb8 \xd0\xbf\xd0\xbe \xd1\x81\xd1\x82\xd0\xb0\xd1\x82\xd1\x83\xd1\x81\xd1\x83 &quot;\xd0\x9f\xd1\x80\xd0\xb8\xd0\xbd\xd1\x8f\xd1\x82\xd0\xbe&quot;\n    hr integer DEFAULT 0, -- id \xd1\x81\xd0\xbe\xd1\x82\xd1\x80\xd1\x83\xd0\xb4\xd0\xbd\xd0\xb8\xd0\xba\xd0\xb0, \xd0\xbe\xd1\x82\xd0\xb2\xd0\xb5\xd1\x82\xd1\x81\xd1\x82\xd0\xb2\xd0\xb5\xd0\xbd\xd0\xbd\xd0\xbe\xd0\xb3\xd0\xbe \xd0\xb7\xd0\xb0 \xd0\xb2\xd0\xb0\xd0\xba\xd0\xb0\xd0\xbd\xd1\x81\xd0\xb8\xd1\x8e\n    auto_trash boolean DEFAULT NULL, -- \xd0\xb0\xd1\x80\xd1\x85\xd0\xb8\xd0\xb2\xd0\xb8\xd1\x80\xd0\xbe\xd0\xb2\xd0\xb0\xd0\xbd\xd0\xbe \xd0\xbb\xd0\xb8 \xd1\x80\xd0\xb5\xd0\xb7\xd1\x8e\xd0\xbc\xd0\xb5 \xd0\xb0\xd0\xb2\xd1\x82\xd0\xbe\xd0\xbc\xd0\xb0\xd1\x82\xd0\xb8\xd1\x87\xd0\xb5\xd1\x81\xd0\xba\xd0\xb8\n    email character varying DEFAULT \'\', -- email\n    refuse_reason_id integer DEFAULT 0, -- \xd0\xb8\xd0\xb4\xd0\xb5\xd1\x88\xd0\xbd\xd0\xb8\xd0\xba \xd0\xbf\xd1\x80\xd0\xb8\xd1\x87\xd0\xb8\xd0\xbd\xd1\x8b \xd0\xbe\xd1\x82\xd0\xba\xd0\xb0\xd0\xb7\xd0\xb0\n    trash_reason_id integer DEFAULT 0, -- \xd0\xb8\xd0\xb4\xd0\xb5\xd1\x88\xd0\xbd\xd0\xb8\xd0\xba \xd0\xbf\xd1\x80\xd0\xb8\xd1\x87\xd0\xb8\xd0\xbd\xd1\x8b \xd0\xbf\xd0\xb5\xd1\x80\xd0\xb5\xd0\xbd\xd0\xbe\xd1\x81\xd0\xb0 \xd0\xb2 \xd0\xb0\xd1\x80\xd1\x85\xd0\xb8\xd0\xb2\n    active_with_auto_trash boolean DEFAULT false, -- \xd1\x84\xd0\xbb\xd0\xb0\xd0\xb3: \xd1\x83\xd1\x87\xd0\xb8\xd1\x82\xd1\x8b\xd0\xb2\xd0\xb0\xd1\x82\xd1\x8c \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5\xd1\x82 \xd0\xb0\xd0\xba\xd1\x82\xd0\xb8\xd0\xb2\xd0\xbd\xd1\x8b\xd0\xb5 \xd0\xb8 trash + auto_trash \xd0\xb2\xd0\xbc\xd0\xb5\xd1\x81\xd1\x82\xd0\xb5\n    dismissal_reason_id integer DEFAULT -1, -- \xd0\xb8\xd0\xb4\xd0\xb5\xd1\x88\xd0\xbd\xd0\xb8\xd0\xba \xd0\xbf\xd1\x80\xd0\xb8\xd1\x87\xd0\xb8\xd0\xbd\xd1\x8b \xd1\x83\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8c\xd0\xbd\xd0\xb5\xd0\xbd\xd0\xb8\xd1\x8f\n    dismissal_type integer DEFAULT 0, -- \xd1\x82\xd0\xb8\xd0\xbf \xd1\x83\xd0\xb2\xd0\xbe\xd0\xbb\xd1\x8c\xd0\xbd\xd0\xb5\xd0\xbd\xd0\xb8\xd1\x8f\n    recall_reason integer DEFAULT 0, -- \xd0\xbf\xd1\x80\xd0\xb8\xd1\x87\xd0\xb8\xd0\xbd\xd0\xb0 \xd0\xbd\xd0\xb5\xd0\xbe\xd0\xb1\xd1\x85\xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbc\xd0\xbe\xd1\x81\xd1\x82\xd0\xb8 \xd0\xbf\xd0\xb5\xd1\x80\xd0\xb5\xd0\xb7\xd0\xb2\xd0\xbe\xd0\xbd\xd0\xb8\xd1\x82\xd1\x8c\n    is_probation_done boolean DEFAULT NULL, -- \xd0\xbf\xd1\x80\xd0\xbe\xd1\x88\xd0\xb5\xd0\xbb \xd0\xb8\xd0\xbb\xd0\xb8 \xd0\xbd\xd0\xb5 \xd0\xbf\xd1\x80\xd0\xbe\xd1\x88\xd0\xb5\xd0\xbb \xd0\xb8\xd1\x81\xd0\xbf\xd1\x8b\xd1\x82\xd0\xb0\xd1\x82\xd0\xb5\xd0\xbb\xd1\x8c\xd0\xbd\xd1\x8b\xd0\xb9 \xd1\x81\xd1\x80\xd0\xbe\xd0\xba (35 \xd0\xb4\xd0\xbd\xd0\xb5\xd0\xb9)\n    is_interview boolean DEFAULT false, -- \xd0\xbf\xd0\xbe\xd0\xba\xd0\xb0\xd0\xb7\xd0\xb0\xd1\x82\xd0\xb5\xd0\xbb\xd1\x8c \xd1\x82\xd0\xbe\xd0\xb3\xd0\xbe, \xd1\x87\xd1\x82\xd0\xbe \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb0 \xd0\xb2 \xd1\x81\xd1\x82\xd0\xb0\xd1\x82\xd1\x83\xd1\x81\xd0\xb5 &quot;\xd0\xa1\xd0\xbe\xd0\xb1\xd0\xb5\xd1\x81\xd0\xb5\xd0\xb4\xd0\xbe\xd0\xb2\xd0\xb0\xd0\xbd\xd0\xb8\xd0\xb5&quot;\n    with_comment_status boolean DEFAULT false, -- \xd0\xbf\xd0\xbe\xd0\xba\xd0\xb0\xd0\xb7\xd0\xb0\xd1\x82\xd0\xb5\xd0\xbb\xd1\x8c \xd1\x82\xd0\xbe\xd0\xb3\xd0\xbe, \xd0\xbd\xd0\xb5\xd0\xbe\xd0\xb1\xd1\x85\xd0\xbe\xd0\xb4\xd0\xb8\xd0\xbc\xd0\xb0 \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb0 \xd0\xbf\xd0\xbe\xd1\x81\xd0\xbb\xd0\xb5\xd0\xb4\xd0\xbd\xd0\xb5\xd0\xb3\xd0\xbe \xd0\xba\xd0\xbe\xd0\xbc\xd0\xbc\xd0\xb5\xd0\xbd\xd1\x82\xd0\xb0\xd1\x80\xd0\xb8\xd1\x8f\n    staff_id integer DEFAULT 0, -- id \xd1\x81\xd0\xbe\xd1\x82\xd1\x80\xd1\x83\xd0\xb4\xd0\xbd\xd0\xb8\xd0\xba\xd0\xb0\n    order_field character varying DEFAULT \'self.id\', -- \xd0\xbf\xd0\xbe\xd0\xbb\xd0\xb5 \xd1\x81\xd0\xbe\xd1\x80\xd1\x82\xd0\xb8\xd1\x80\xd0\xbe\xd0\xb2\xd0\xba\xd0\xb8\n    order_direction character varying DEFAULT \'desc\', -- \xd0\xbd\xd0\xb0\xd0\xbf\xd1\x80\xd0\xb0\xd0\xb2\xd0\xbb\xd0\xb5\xd0\xbd\xd0\xb8\xd0\xb5 \xd1\x81\xd0\xbe\xd1\x80\xd1\x82\xd0\xb8\xd1\x80\xd0\xbe\xd0\xb2\xd0\xba\xd0\xb8\n    limitval integer DEFAULT 20, -- \xd0\xbb\xd0\xb8\xd0\xbc\xd0\xb8\xd1\x82 \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb8\n    offsetval integer DEFAULT 0 -- \xd1\x81\xd0\xb4\xd0\xb2\xd0\xb8\xd0\xb3 \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb8\n) returns setof record\n as $$\nDECLARE\n    q_fields varchar := \'\'; -- \xd0\xbf\xd0\xbe\xd0\xbb\xd1\x8f \xd0\xb2 \xd0\xb2\xd1\x8b\xd0\xb1\xd0\xbe\xd1\x80\xd0\xba\xd0\xb5\n    q varchar := \'\'; -- \xd1\x81\xd0\xb0\xd0\xbc \xd0\xb7\xd0\xb0\xd0\xbf\xd1\x80\xd0\xbe\xd1\x81\n    q_where varchar := \' WHERE \'; -- \xd1\x81\xd1\x82\xd1\x80\xd0\xbe\xd0\xba\xd0\xb0 \xd1\x83\xd1\x81\xd0\xbb\xd0\xbe\xd0\xb2\xd0\xb8\xd0\xb9\n    list record;\nBEGIN\n    q_fields := \'\n        SELECT\n        &quot;self&quot;.&quot;id&quot;,\n        &quot;self&quot;.&quot;status&quot;,\n        &quot;self&quot;.&quot;channel&quot;,\n        &quot;self&quot;.&quot;source&quot;,\n        &quot;self&quot;.&quot;name&quot;,\n        &quot;self&quot;.&quot;firstname&quot;,\n        &quot;self&quot;.&quot;patronymic&quot;,\n        &quot;self&quot;.&quot;resume_file_name&quot;,\n        &quot;self&quot;.&quot;date&quot;,\n        &quot;self&quot;.&quot;birthday&quot;,\n        &quot;self&quot;.&quot;post_id&quot;,\n        &quot;self&quot;.&quot;site_id&quot;,\n        &quot;self&quot;.&quot;education1&quot;,\n        &quot;self&quot;.&quot;education2&quot;,\n        &quot;self&quot;.&quot;class_institution&quot;,\n        &quot;self&quot;.&quot;selection_type&quot;,\n        coalesce(self.hunter_score::text::integer, 0) AS &quot;hunter_score&quot;,\n        &quot;self&quot;.&quot;experience_years&quot;,\n        &quot;self&quot;.&quot;sex&quot;,\n        &quot;self&quot;.&quot;email&quot;,\n        &quot;self&quot;.&quot;vacancy_id&quot;,\n        &quot;self&quot;.&quot;age&quot;,\n        &quot;self&quot;.&quot;photo_present&quot;,\n        &quot;self&quot;.&quot;is_responce&quot;,\n        &quot;self&quot;.&quot;is_paid&quot;,\n        &quot;self&quot;.&quot;estimated_post&quot;,\n        &quot;self&quot;.&quot;url&quot;,\n        &quot;self&quot;.&quot;vacancy_id&quot;,\n        &quot;self&quot;.&quot;refuse_reason_id&quot;,\n        &quot;self&quot;.&quot;tentative_date&quot;,\n        &quot;self&quot;.&quot;resume_text&quot;,\n        &quot;self&quot;.&quot;test_result&quot;,\n        &quot;self&quot;.&quot;test_staff_id&quot;,\n        &quot;self&quot;.&quot;accept_date&quot;,\n        &quot;self&quot;.&quot;dismissal_date&quot;,\n        &quot;self&quot;.&quot;dismissal_reason_id&quot;,\n        &quot;self&quot;.&quot;recall_reason&quot;,\n        &quot;self&quot;.&quot;resume_file_name&quot;,\n        &quot;self&quot;.&quot;photo_name&quot;,\n        age(coalesce(birthday::timestamp, now()))::interval YEAR AS &quot;age&quot;,\n        (\n            SELECT\n                coalesce((staff.surname || \\\' \\\' || staff.name), \\\'\\\')\n            FROM\n                hr.hr_resume_log as log\n            LEFT JOIN\n                lspassport.lspassport_staff_base as staff ON staff.id = log.lst_staff_id\n            WHERE\n                log.candidate_id = self.id AND\n                log.new_status_id = self.status AND\n                log.old_status_id = log.new_status_id\n            ORDER BY\n                log.id desc\n            LIMIT 1\n        ) AS &quot;powerful_staff&quot;,\n        (\n            SELECT\n                (CASE WHEN log.date IS NULL THEN now() ELSE log.date END)\n            FROM\n                hr.hr_resume_log as log\n            WHERE\n                log.candidate_id = self.id\n                AND log.new_status_id = self.status\n                AND log.old_status_id &lt;&gt; log.new_status_id\n            ORDER BY\n                log.id desc\n            LIMIT 1\n        ) AS &quot;date_status&quot;,\n        (\n            SELECT\n                log.id\n            FROM\n                hr.hr_resume_log as log\n            WHERE\n                log.candidate_id = self.id\n                AND log.new_status_id = self.status\n                AND log.old_status_id &lt;&gt; log.new_status_id\n            ORDER BY\n                log.id desc\n            LIMIT 1\n        ) AS &quot;log_id&quot;,\n        (\n            SELECT\n                log.called\n            FROM\n                hr.hr_resume_log as log\n            WHERE\n                log.candidate_id = self.id AND\n                log.new_status_id = self.status AND\n                log.old_status_id &lt;&gt; log.new_status_id\n            ORDER BY\n                log.id desc\n            LIMIT 1\n        ) AS &quot;called&quot;,\n        (\n            SELECT\n                coalesce((staff.surname || \\\' \\\' || staff.name || \\\' \\\' || staff.patronymic), \\\'\\\')\n            FROM\n                hr.hr_resume_log as log\n            LEFT JOIN\n                lspassport.lspassport_staff_base as staff ON staff.id = log.lst_staff_id\n            WHERE\n                log.candidate_id = self.id\n                AND log.new_status_id = self.status\n                AND log.old_status_id &lt;&gt; log.new_status_id\n            ORDER BY\n                log.id desc\n            LIMIT 1\n        ) AS &quot;lst_staff&quot;,\n        (\n            SELECT\n                coalesce(role.code, \'\')\n            FROM\n                hr.hr_vacancy_staff_role as role\n            WHERE\n                role.vacancy_id = self.vacancy_id\n                AND role.lst_staff_id = \' || staff_id || \'\n                AND role.role = 3\n        ) AS &quot;role_code&quot;,\n        &quot;site&quot;.&quot;name&quot; AS &quot;site_name&quot;,\n        &quot;site&quot;.&quot;url&quot; AS &quot;site_url&quot;,\n        &quot;reason&quot;.&quot;name&quot; AS &quot;refuse_reason&quot;,\n        (staff.surname || \\\' \\\' || staff.name || \\\' \\\' || staff.patronymic) AS &quot;hunter_name&quot;,\n        coalesce(action.date_test_end, \\\'1970-01-01 00:00:00\\\') date_test_end,\n        &quot;action&quot;.&quot;date_test_start&quot;,\n        &quot;action&quot;.&quot;date_test_end&quot;,\n        &quot;action&quot;.&quot;date_request&quot;,\n        &quot;action&quot;.&quot;current_step&quot;,\n        &quot;action&quot;.&quot;key&quot;,\n        &quot;test&quot;.&quot;id&quot; AS &quot;test_id&quot;,\n        &quot;test&quot;.&quot;step&quot; AS &quot;test_step&quot;\';\n\n    q := \' FROM hr.hr_candidate as self\n        LEFT JOIN &quot;hr&quot;.&quot;hr_site&quot; AS &quot;site&quot; ON self.site_id = site.id\n        LEFT JOIN &quot;hr&quot;.&quot;hr_refuse_reason&quot; AS &quot;reason&quot; ON self.refuse_reason_id = reason.id\n        LEFT JOIN &quot;lspassport&quot;.&quot;lspassport_staff_base&quot; AS &quot;staff&quot; ON self.hunter = staff.id\n        LEFT JOIN &quot;hr&quot;.&quot;hr_candidate_action&quot; AS &quot;action&quot; ON self.id = action.candidate_id\n        LEFT JOIN &quot;hr&quot;.&quot;hr_candidate_test&quot; AS &quot;test&quot; ON self.vacancy_id = test.vacancy_id\';\n\n    IF (status != 0) THEN\n        q_where := q_where || \' self.status = \' || status || \' AND \';\n    END IF;\n\n    IF (trash IS NOT NULL) THEN\n        IF (trash) THEN\n            q_where := q_where || \' self.trash = true\';\n\n            IF (auto_trash IS NOT NULL) THEN\n                q_where := q_where || \' AND self.auto_trash = \' || auto_trash;\n            END IF;\n\n            IF (trash_reason_id != 0) THEN\n                q_where := q_where || \' AND self.trash_reason_id = \' || trash_reason_id;\n            END IF;\n        ELSE\n            q_where := q_where || \' self.trash = false\';\n        END IF;\n    ELSE\n        IF (active_with_auto_trash) THEN\n            q_where := q_where || \' (self.trash = false OR (self.trash = true AND self.auto_trash = \' || auto_trash || \'))\';\n        ELSE\n            q_where := q_where || \' self.status IS NOT NULL\'; -- \xd1\x8d\xd1\x82\xd0\xbe \xd1\x85\xd0\xb0\xd0\xba, \xd1\x87\xd1\x82\xd0\xbe\xd0\xb1\xd1\x8b \xd0\xb1\xd0\xbb\xd0\xbe\xd0\xba \xd1\x83\xd1\x81\xd0\xbb\xd0\xbe\xd0\xb2\xd0\xb8\xd0\xb9 \xd0\xbd\xd0\xb5 \xd0\xbd\xd0\xb0\xd1\x87\xd0\xb8\xd0\xbd\xd0\xb0\xd0\xbb\xd1\x81\xd1\x8f \xd1\x81 AND\n        END IF;\n    END IF;\n\n    IF (date != \'\') THEN\n        IF (count_on_accepted) THEN\n            q_where := q_where || \' AND to_char(log.date, \' || quote_literal(date_format) || \') = \' || quote_literal(date);\n        ELSE\n            q_where := q_where || \' AND to_char(self.date, \' || quote_literal(date_format) || \') = \' || quote_literal(date);\n        END IF;\n    END IF;\n\n    IF (id != 0) THEN\n        q_where := q_where || \' AND self.id = \' || id;\n    END IF;\n\n    IF (name != \'\') THEN\n        q_where := q_where || \' AND self.name ILIKE \' || quote_literal(\'%\' || name || \'%\');\n    END IF;\n\n    IF (firstname != \'\') THEN\n        q_where := q_where || \' AND self.firstname ILIKE \' || quote_literal(\'%\' || firstname || \'%\');\n    END IF;\n\n    IF (patronymic != \'\') THEN\n        q_where := q_where || \' AND self.patronymic ILIKE \' || quote_literal(\'%\' || patronymic || \'%\');\n    END IF;\n\n    IF (source != 0) THEN\n        IF (source = 1004) THEN\n            q_where := q_where || \' AND self.channel = \' || quote_literal(\'hh.lbc.ru\');\n        ELSE\n            q_where := q_where || \' AND self.source = \' || source;\n        END IF;\n    END IF;\n\n    IF (date_from IS NOT NULL) THEN\n        q_where := q_where || \' AND self.date &gt;= \' || quote_literal(date_from);\n    END IF;\n\n    IF (date_to IS NOT NULL) THEN\n        q_where := q_where || \' AND self.date &lt;= \' || quote_literal(date_to);\n    END IF;\n\n    IF (hunter != 0) THEN\n        q_where := q_where || \' AND self.hunter = \' || hunter;\n    END IF;\n\n    IF (vacancy_id != 0) THEN\n        q_where := q_where || \' AND self.vacancy_id = \' || vacancy_id;\n    END IF;\n\n    IF (post_id != 0) THEN\n        q_where := q_where || \' AND self.post_id = \' || post_id;\n    END IF;\n\n    IF (hunter_score != \'\') THEN\n        q_where := q_where || \' AND self.hunter_score::text = \' || quote_literal(hunter_score);\n    END IF;\n\n    IF (photo_present &gt; -1) THEN\n        q_where := q_where || \' AND self.photo_present::integer = \' || photo_present;\n    END IF;\n\n    IF (is_responce &gt; -1) THEN\n        q_where := q_where || \' AND self.is_responce = \' || is_responce;\n    END IF;\n\n    IF (is_paid IS NOT NULL) THEN\n        q_where := q_where || \' AND self.is_paid = \' || is_paid;\n    END IF;\n\n    IF (is_test_complete IS NOT NULL) THEN\n        q_where := q_where || \' AND (\n                SELECT\n                    act.date_test_end\n                FROM\n                    hr.hr_candidate_action as act\n                WHERE\n                    act.candidate_id = self.id\n                    AND act.date_test_start IS NOT NULL\n                ORDER BY\n                    act.id desc\n                LIMIT 1\n            )\';\n\n        IF (is_test_complete) THEN\n            q_where := q_where || \' IS NOT NULL\';\n        ELSE\n            q_where := q_where || \' IS NULL\';\n        END IF;\n    END IF;\n\n    IF (count_on_accepted) THEN\n        q := q || \' JOIN hr.hr_resume_log as log ON log.candidate_id = self.id\';\n\n        q_where := q_where || \'\n            AND log.new_status_id = \' || status || \'\n            AND log.old_status_id &lt;&gt; log.new_status_id\n            AND log.new_status_id = self.status\';\n    END IF;\n\n    IF (hr != 0) THEN\n        q := q || \' JOIN hr.hr_vacancy_staff_role as role ON role.vacancy_id = self.vacancy_id AND role.role = 1\';\n\n        q_where := q_where || \'\n            AND role.lst_staff_id = \' || hr;\n    END IF;\n\n    IF (email != \'\') THEN\n        q_where := q_where || \' AND self.email ILIKE \' || quote_literal(\'%\' || email || \'%\');\n    END IF;\n\n    IF (refuse_reason_id != 0) THEN\n        q_where := q_where || \' AND self.refuse_reason_id = \' || refuse_reason_id;\n    END IF;\n\n    IF (dismissal_type != 0) THEN\n        IF (dismissal_type = 1) THEN\n            q_where := q_where || \' AND self.dismissal_date is not null AND self.dismissal_reason_id &lt;&gt; 0\';\n        ELSE\n            q := q || \' LEFT JOIN hr.hr_dismissal_reason as dismissal_reason ON self.dismissal_reason_id = dismissal_reason.id\';\n\n            IF (dismissal_type = 2) THEN\n                q_where := q_where || \'\n                    AND dismissal_reason.by_self = true\';\n            END IF;\n\n            IF (dismissal_type = 3) THEN\n                q_where := q_where || \'\n                    AND dismissal_reason.by_self = false\';\n            END IF;\n        END IF;\n    END IF;\n\n    IF (dismissal_reason_id != -1) THEN\n        q_where := q_where || \' AND self.dismissal_reason_id = \' || dismissal_reason_id;\n        IF (dismissal_reason_id = 0) THEN\n            q_where := q_where || \' AND self.dismissal_date is null\';\n        END IF;\n    END IF;\n\n    IF (recall_reason != 0) THEN\n        q_where := q_where || \' AND self.recall_reason = \' || recall_reason;\n    END IF;\n\n    IF (is_probation_done IS NOT NULL) THEN\n        q_where := q_where || \' AND self.dismissal_date is not null AND self.accept_date is not null\';\n        IF (is_probation_done = TRUE) THEN\n            q_where := q_where || \' AND date(self.accept_date) + interval\\\'35 days\\\' &lt; self.dismissal_date\';\n        ELSE\n            q_where := q_where || \' AND date(self.accept_date) + interval\\\'35 days\\\' &gt;= self.dismissal_date\';\n        END IF;\n    END IF;\n\n    IF (is_interview) THEN\n        q_fields := q_fields || \',\n            (\n                SELECT\n                    fi.date\n                FROM\n                    hr.hr_candidate_interview as fi\n                WHERE\n                    fi.candidate_id = self.id AND\n                    fi.number = 1\n                ORDER BY\n                    fi.id desc\n                LIMIT 1\n            ) as first_interview_date,\n            (\n                SELECT\n                    si.date\n                FROM\n                    hr.hr_candidate_interview as si\n                WHERE\n                    si.candidate_id = self.id AND\n                    si.number = 1\n                ORDER BY\n                    si.id desc\n                LIMIT 1\n            ) as second_interview_date\';\n    END IF;\n\n    IF (with_comment_status) THEN\n        q_fields := q_fields || \',\n            (\n                SELECT\n                    (CASE WHEN log.comment IS NULL THEN \'\' ELSE log.comment END)\n                FROM\n                    hr.hr_resume_log as log\n                WHERE\n                    log.candidate_id = self.id\n                ORDER BY\n                    log.id desc\n                LIMIT 1\n            ) as status_comment\';\n    END IF;\n\n    q := q_fields || q || q_where || \' ORDER BY \' || order_field || \' \' || order_direction || \' LIMIT \' || limitval || \' OFFSET \' || offsetval;\n\n    RAISE NOTICE  \'SQL: %\', q;\n\n FOR list IN EXECUTE q LOOP\n     RETURN NEXT list;\n    END LOOP;\nEND;\n$$ LANGUAGE plpgsql;\n</code></pre></p> <p align="right"><span style="font-size: 60%">Add a code snippet to your website: <a href="https://www.paste.org" target="_blank">www.paste.org</a></span></p> </body> </html>'